<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Cribbage Trainer — Light, Friendly, ACC-faithful</title>
<style>
  :root{
    --bg:#f8f6f2;
    --ink:#2c2b28;
    --muted:#6e6a63;
    --wood1:#e7d7c4;  /* light maple tones */
    --wood2:#f3e6d7;
    --wood3:#e9dccb;
    --edge:#d7c7b2;
    --accent:#2d7ff9;
    --ok:#20a05a;

    --hole:22px;
    --gap:7px;
    --peg:14px;
    --trackCols:61;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0; background:var(--bg); color:var(--ink);
    font:15px/1.45 ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
  }

  header{
    display:flex; align-items:center; justify-content:space-between;
    padding:16px 18px 10px; border-bottom:1px solid #e9e2d8;
  }
  header h1{margin:0; font-weight:700; font-size:18px; letter-spacing:.2px}
  .subtle{color:var(--muted); font-size:12px}

  main{max-width:980px; margin:12px auto 40px; padding:0 16px; display:grid; gap:14px}

  /* STATUS BAR */
  .status{display:flex; gap:10px; align-items:center; flex-wrap:wrap}
  .chip{
    padding:8px 12px; border-radius:999px; border:1px solid #e9e2d8;
    background:#fffefc; box-shadow:0 1px 0 rgba(0,0,0,.03);
    font-weight:600;
  }
  .mono{font-family:ui-monospace,Menlo,Consolas,monospace}

  /* BOARD */
  .board{
    padding:14px; border-radius:14px; border:1px solid var(--edge);
    background:
      linear-gradient(90deg, rgba(255,255,255,.2) 0, transparent 30%),
      linear-gradient(180deg, var(--wood2), var(--wood1));
    box-shadow:0 6px 28px rgba(139,109,70,.18), inset 0 1px 0 rgba(255,255,255,.35);
    display:grid; gap:14px;
  }
  .track-title{display:flex; justify-content:space-between; font-size:12px; color:var(--muted)}
  .track{
    display:grid;
    grid-template-columns:repeat(var(--trackCols), var(--hole));
    gap:var(--gap);
    place-items:center;
    justify-content:center;
  }
  .row2{margin-top:8px}

  .hole{
    width:var(--hole); height:var(--hole); border-radius:50%;
    background:radial-gradient(circle at 35% 35%, #fff 0 15%, #c9b89f 55%, #ad9a7d 100%);
    box-shadow:
      inset 0 1px 1px rgba(255,255,255,.7),
      inset 0 -1px 2px rgba(0,0,0,.15),
      0 0 0 1px rgba(0,0,0,.05);
    position:relative;
  }
  .hole[data-idx="121"]{outline:2px solid var(--ok); background:radial-gradient(circle at 35% 35%, #fff 0 15%, #cfead7 55%, #b6d9c0 100%)}
  .hole[data-idx="0"]{outline:2px solid #aec2f9}

  /* Peg sprites live in an overlay and MOVE between hole centers */
  .peg-layer{position:relative}
  .peg-sprite{
    position:absolute; width:var(--peg); height:var(--peg); border-radius:50%;
    transform:translate(-50%, -50%);
    box-shadow:0 2px 0 rgba(0,0,0,.12), 0 8px 16px rgba(0,0,0,.15);
    transition:left .28s ease, top .28s ease;
  }
  .p1.front{background:radial-gradient(circle at 30% 30%, #ff9aa0 0 20%, #ff4d5a 70%, #d1323c 100%)}
  .p1.back {background:radial-gradient(circle at 30% 30%, #ffd0d3 0 20%, #ff8b95 70%, #c2565e 100%)}
  .p2.front{background:radial-gradient(circle at 30% 30%, #9dc8ff 0 20%, #4da3ff 70%, #2e79d1 100%)}
  .p2.back {background:radial-gradient(circle at 30% 30%, #d0e3ff 0 20%, #99c5ff 70%, #5186d6 100%)}

  /* COUNTING LANE (0–31) */
  .count-panel{
    padding:10px 12px; border-radius:14px; border:1px solid var(--edge);
    background:linear-gradient(180deg,#ffffff,#fbf8f4);
    display:grid; gap:10px;
  }
  .count-title{display:flex; justify-content:space-between; font-size:12px; color:var(--muted)}
  .count-lane{
    display:grid; grid-template-columns:repeat(32, 18px); gap:6px; justify-content:center; align-items:center;
  }
  .pip{
    width:18px; height:18px; border-radius:50%;
    box-shadow:inset 0 1px 1px rgba(0,0,0,.08), 0 1px 0 rgba(255,255,255,.7);
    background:#e9e2d8;
  }
  .pip.fill{ background:linear-gradient(180deg,#93d2a7,#64c087); }
  .pip.mark15{ outline:2px dashed #9bb7ff; }
  .count-big{font-weight:800; font-size:28px; letter-spacing:.5px}

  /* CONTROLS */
  .panel{
    padding:12px; border-radius:14px; border:1px solid var(--edge);
    background:linear-gradient(180deg,#ffffff,#fbf8f4);
    display:grid; gap:10px;
  }
  .row{display:flex; flex-wrap:wrap; gap:8px; align-items:center}
  button{
    border-radius:12px; padding:9px 12px; border:1px solid #ded7cc; background:#fff; color:var(--ink);
    box-shadow:0 1px 0 rgba(255,255,255,.7), 0 1px 0 rgba(0,0,0,.03);
    cursor:pointer; font-weight:700;
  }
  button.primary{background:#2d7ff9; color:white; border-color:#2167ce; box-shadow:0 1px 0 rgba(255,255,255,.35), 0 8px 14px rgba(45,127,249,.25)}
  button:disabled{opacity:.5; cursor:not-allowed}
  .badge{
    padding:6px 10px; border:1px solid #ede7de; background:#fff; border-radius:10px; font-size:13px;
    box-shadow:0 1px 0 rgba(255,255,255,.6);
  }
  .seq{display:flex; gap:6px; flex-wrap:wrap; min-height:28px; padding:6px 8px; border:1px solid #ede7de; background:#fff; border-radius:10px; font-family:ui-monospace,Menlo,Consolas,monospace}

  /* A..K chips */
  .chipbtn{
    border-radius:999px; padding:8px 10px; min-width:36px; text-align:center; font-weight:800;
    border:1px solid #e6ded2; background:#ffffff;
  }

  /* Focus */
  :focus-visible{outline:2px solid #a8d6ff; outline-offset:2px; border-radius:12px}
</style>
</head>
<body>
<header>
  <h1>Cribbage Trainer</h1>
  <div class="subtle">warm board • real peg motion • ACC-faithful pegging</div>
</header>

<main>
  <!-- STATUS -->
  <div class="status">
    <div class="chip">Dealer: <strong id="dealerLbl">P2</strong> • Pone: <strong id="poneLbl">P1</strong></div>
    <div class="chip">Turn: <strong id="turnLbl">P1</strong></div>
    <div class="chip">Running <span class="mono" id="countLbl">0</span></div>
    <div class="chip">Last: <span id="lastLbl">—</span></div>
  </div>

  <!-- BOARD -->
  <section class="board" aria-label="Pegboard">
    <div class="track-title"><span>P1 Track</span><span>Game hole 121</span></div>
    <div class="peg-layer">
      <div class="track" id="p1r1"></div>
      <div class="track row2" id="p1r2"></div>
      <div id="pegP1Front" class="peg-sprite p1 front"></div>
      <div id="pegP1Back"  class="peg-sprite p1 back"></div>
    </div>

    <div class="track-title"><span>P2 Track</span><span>Game hole 121</span></div>
    <div class="peg-layer">
      <div class="track" id="p2r1"></div>
      <div class="track row2" id="p2r2"></div>
      <div id="pegP2Front" class="peg-sprite p2 front"></div>
      <div id="pegP2Back"  class="peg-sprite p2 back"></div>
    </div>
  </section>

  <!-- COUNTING LANE -->
  <section class="count-panel" aria-label="Running Count">
    <div class="count-title"><span>Running count lane (0–31)</span><span class="count-big" id="countBig">0</span></div>
    <div id="lane" class="count-lane"></div>
  </section>

  <!-- CONTROLS -->
  <section class="panel" aria-label="Controls">
    <div class="row">
      <div class="badge">Starter: <strong id="starterBadge">—</strong></div>
      <button id="btnCut" class="primary" title="Cut the starter">Cut Starter</button>
      <button id="btnHeels" title="Dealer +2 if starter is a Jack">His Heels +2</button>
      <div style="margin-left:auto"></div>
      <button id="btnGo" title="If you cannot play, call Go">Go</button>
      <button id="btnReset" title="Clear the current sequence">Reset Seq</button>
      <button id="btnUndo">Undo</button>
      <button id="btnSwap" title="Swap dealer/pone">Swap Dealer</button>
      <button id="btnNew">New Game</button>
    </div>

    <div class="row">
      <div class="badge">Current sequence</div>
      <div id="seq" class="seq" aria-live="polite"></div>
    </div>

    <div class="row">
      <div class="badge">Play a card</div>
      <div id="cardRow" class="row"></div>
    </div>
  </section>
</main>

<script>
/* ================== Model ================== */
const label = r => ({11:'J',12:'Q',13:'K'}[r] || (r===1?'A':r));
const val   = r => Math.min(r,10);

const P1 = { id:'P1', front:0, back:0 };
const P2 = { id:'P2', front:0, back:0 };

let dealer=P2, pone=P1, leader=pone, turn=leader;
let starter=null, heelsAvailable=false;
let seq=[], running=0;
let go={active:false, caller:null, lastPlayer:null};
let gameOver=false;

const undo=[];

/* ================== DOM ================== */
const p1r1=document.getElementById('p1r1'), p1r2=document.getElementById('p1r2');
const p2r1=document.getElementById('p2r1'), p2r2=document.getElementById('p2r2');
const dealerLbl=document.getElementById('dealerLbl'), poneLbl=document.getElementById('poneLbl');
const turnLbl=document.getElementById('turnLbl'), countLbl=document.getElementById('countLbl'), countBig=document.getElementById('countBig');
const lastLbl=document.getElementById('lastLbl'), starterBadge=document.getElementById('starterBadge');
const seqEl=document.getElementById('seq'), cardRow=document.getElementById('cardRow');
const btnCut=document.getElementById('btnCut'), btnHeels=document.getElementById('btnHeels');
const btnGo=document.getElementById('btnGo'), btnReset=document.getElementById('btnReset');
const btnUndo=document.getElementById('btnUndo'), btnSwap=document.getElementById('btnSwap');
const btnNew=document.getElementById('btnNew');
const lane=document.getElementById('lane');

const pegP1F=document.getElementById('pegP1Front'), pegP1B=document.getElementById('pegP1Back');
const pegP2F=document.getElementById('pegP2Front'), pegP2B=document.getElementById('pegP2Back');

/* ================== Board Build ================== */
function buildRow(container, from, to){
  container.innerHTML='';
  for(let i=from;i<=to;i++){
    const h=document.createElement('div'); h.className='hole'; h.dataset.idx=i; container.appendChild(h);
  }
}
function holeEl(player, idx){
  const topRow = (player===P1) ? p1r1 : p2r1;
  const botRow = (player===P1) ? p1r2 : p2r2;
  const row = (idx<=60) ? topRow : botRow;
  return row.querySelector(`.hole[data-idx="${idx}"]`);
}
function centerOf(el){
  const r = el.getBoundingClientRect();
  const pr = el.offsetParent.getBoundingClientRect();
  return { left: (r.left + r.width/2) - pr.left, top: (r.top + r.height/2) - pr.top };
}
function placePegSprites(){
  [ [P1,pegP1F,pegP1B], [P2,pegP2F,pegP2B] ].forEach(([pl, pf, pb])=>{
    const fC = centerOf(holeEl(pl, pl.front));
    pf.style.left = fC.left + 'px'; pf.style.top = fC.top + 'px';
    const bC = centerOf(holeEl(pl, pl.back));
    pb.style.left = bC.left + 'px'; pb.style.top = bC.top + 'px';
  });
}
function redrawAll(){
  dealerLbl.textContent=dealer.id; poneLbl.textContent=pone.id; turnLbl.textContent=turn.id;
  countLbl.textContent=running; countBig.textContent=running;
  seqEl.innerHTML = seq.map(c=>`<span class="badge mono">${c.player.id}:${label(c.rank)}(${c.value})</span>`).join('');
  starterBadge.textContent = starter ? `${label(starter.rank)}${starter.suit}` : '—';
  btnHeels.disabled = !(starter && starter.rank===11 && heelsAvailable) || gameOver;
  btnGo.disabled = gameOver || seq.length===0;
  btnUndo.disabled = undo.length===0 || gameOver;
  fillLane();
  placePegSprites();
}

/* ================== Counting Lane 0–31 ================== */
function buildLane(){
  lane.innerHTML='';
  for(let i=0;i<=31;i++){
    const p=document.createElement('div'); p.className='pip'; if(i===15) p.classList.add('mark15');
    lane.appendChild(p);
  }
}
function fillLane(){
  const pips = lane.querySelectorAll('.pip');
  pips.forEach((p,i)=> p.classList.toggle('fill', i>0 && i<=running));
}

/* ================== Undo Snapshots ================== */
function snapshot(label=''){
  undo.push({
    label, P1:{...P1}, P2:{...P2},
    leader:leader.id, dealer:dealer.id, pone:pone.id, turn:turn.id,
    starter: starter?{...starter}:null, heelsAvailable,
    seq:[...seq], running, go:{...go}, last:lastLbl.textContent, gameOver
  });
  btnUndo.disabled=false;
}
function restore(s){
  Object.assign(P1,s.P1); Object.assign(P2,s.P2);
  leader=(s.leader==='P1')?P1:P2; dealer=(s.dealer==='P1')?P1:P2; pone=(s.pone==='P1')?P1:P2; turn=(s.turn==='P1')?P1:P2;
  starter=s.starter?{...s.starter}:null; heelsAvailable=s.heelsAvailable;
  seq=[...s.seq]; running=s.running; go={...s.go}; lastLbl.textContent=s.last; gameOver=s.gameOver;
  redrawAll();
}

/* ================== Peg Motion (animated leapfrog) ================== */
function animateLeapfrog(player, points, reason=''){
  if(points<=0) return;
  snapshot(`peg ${player.id} +${points} ${reason}`);
  const fromIdx = player.back;
  const toIdx = Math.min(121, fromIdx + points);

  // Move the BACK sprite to the destination
  const sprite = (player===P1) ? pegP1B : pegP2B;
  const targetCenter = centerOf(holeEl(player, toIdx));
  sprite.style.left = targetCenter.left + 'px';
  sprite.style.top  = targetCenter.top  + 'px';

  // After the transition, swap roles and finalize
  sprite.addEventListener('transitionend', onDone, {once:true});
  function onDone(){
    player.back = toIdx;
    // swap front/back roles in model
    [player.front, player.back] = [player.back, player.front];

    // Ensure both sprites are snapped to their new holes
    placePegSprites();

    lastLbl.textContent = `${player.id} +${points}${reason?` ${reason}`:''}`;
    if(player.front>=121){ gameOver=true; lastLbl.textContent = `${player.id} pegs out`; }
  }
}

/* ================== Scoring Helpers ================== */
function scoreRunTail(arr){
  let best=0;
  for(let k=arr.length;k>=3;k--){
    const t=arr.slice(-k).map(x=>x.rank);
    if(new Set(t).size!==k) continue;
    const mn=Math.min(...t), mx=Math.max(...t);
    if(mx-mn+1===k){ best=k; break; }
  }
  return best;
}

/* ================== Play Flow ================== */
function playCard(rank){
  if(gameOver) return;
  const value = val(rank);
  if(running + value > 31){ alert("That would exceed 31. If you can't play, press Go."); return; }

  snapshot(`play ${turn.id} ${label(rank)}`);

  if(heelsAvailable) heelsAvailable=false; // first card played forfeits heels if not taken

  seq.push({player:turn, rank, value});
  running += value; go.lastPlayer = turn;

  // pairs / trips / quads
  let same=1;
  for(let i=seq.length-2;i>=0;i--){ if(seq[i].rank===rank) same++; else break; }
  if(same===2) animateLeapfrog(turn,2,'(Pair +2)');
  else if(same===3) animateLeapfrog(turn,6,'(Pair Royal +6)');
  else if(same===4) animateLeapfrog(turn,12,'(Double Pair Royal +12)');

  // runs
  const runPts = scoreRunTail(seq);
  if(runPts>0) animateLeapfrog(turn, runPts, `(Run ${runPts} +${runPts})`);

  // 15 / 31
  if(running===15) animateLeapfrog(turn,2,'(Fifteen +2)');
  if(running===31) animateLeapfrog(turn,2,'(Thirty-one +2)');

  // turn logic
  if(running===31){
    seq=[]; running=0; go={active:false,caller:null,lastPlayer:null};
    leader = (turn===P1)?P2:P1; turn = leader;
  } else {
    if(go.active){
      turn = (go.caller===P1)?P2:P1; // opponent of go-caller may keep playing
    } else {
      turn = (turn===P1)?P2:P1;
    }
  }
  redrawAll();
}

/* ================== Controls ================== */
btnCut.onclick = ()=>{
  if(gameOver) return;
  snapshot('cut');
  const suits=['♣','♦','♥','♠']; const r=1+Math.floor(Math.random()*13); const s=suits[Math.floor(Math.random()*4)];
  starter = {rank:r, suit:s};
  heelsAvailable = (r===11);
  redrawAll();
};
btnHeels.onclick = ()=>{
  if(!(starter && starter.rank===11 && heelsAvailable) || gameOver) return;
  animateLeapfrog(dealer,2,'(His Heels +2)'); heelsAvailable=false; redrawAll();
};
btnGo.onclick = ()=>{
  if(gameOver || seq.length===0) return;
  snapshot('go');
  if(go.active){
    if(running!==31 && go.lastPlayer) animateLeapfrog(go.lastPlayer,1,'(Last card +1)');
    seq=[]; running=0; leader = go.caller; turn = leader; go={active:false,caller:null,lastPlayer:null};
  }else{
    go={active:true, caller:turn, lastPlayer:go.lastPlayer};
    turn = (turn===P1)?P2:P1;
  }
  redrawAll();
};
btnReset.onclick = ()=>{
  if(gameOver) return;
  snapshot('reset');
  seq=[]; running=0; turn=leader; go={active:false,caller:null,lastPlayer:null};
  redrawAll();
};
btnUndo.onclick = ()=>{
  if(undo.length===0 || gameOver) return;
  const s=undo.pop(); restore(s);
};
btnSwap.onclick = ()=>{
  snapshot('swap dealer');
  [dealer,pone] = (dealer===P1)?[P2,P1]:[P1,P2];
  leader=pone; turn=leader; redrawAll();
};
btnNew.onclick = ()=>{
  undo.length=0; Object.assign(P1,{front:0,back:0}); Object.assign(P2,{front:0,back:0});
  starter=null; heelsAvailable=false; seq=[]; running=0; go={active:false,caller:null,lastPlayer:null};
  dealer=P2; pone=P1; leader=pone; turn=leader; gameOver=false; lastLbl.textContent='—';
  redrawAll();
};

/* ================== Card Bar (A..K) ================== */
(function buildCardRow(){
  const ranks=[1,2,3,4,5,6,7,8,9,10,11,12,13];
  ranks.forEach(r=>{
    const b=document.createElement('button'); b.className='chipbtn'; b.textContent=label(r); b.onclick=()=>playCard(r);
    cardRow.appendChild(b);
  });
})();

/* ================== Boot & Layout ================== */
function buildBoard(){
  buildRow(p1r1,0,60); buildRow(p1r2,61,121);
  buildRow(p2r1,0,60); buildRow(p2r2,61,121);
}
buildBoard();
buildLane();
window.addEventListener('resize', placePegSprites);
placePegSprites();
redrawAll();
</script>
</body>
</html>
